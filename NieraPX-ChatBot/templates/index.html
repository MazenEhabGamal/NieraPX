<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NieraPX - Gaming Chatbot</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background: #0a0a0a;
            color: #00ffea;
            text-align: center;
            overflow: hidden;
            transition: background 0.3s, color 0.3s;
        }
        body.light-theme {
            background: #88b5b1;
            color: #333333;
        }
        #chat-container {
            width: 80%;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            border: 2px solid #00ffea;
            box-shadow: 0 0 10px #00ffea;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.8);
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .light-theme #chat-container {
            border-color: #333333;
            box-shadow: 0 0 10px #333333;
            background: rgba(255, 255, 255, 0.9);
        }
        #messages {
            height: 300px;
            overflow-y: auto;
            border-bottom: 2px solid #00ffea;
            padding: 10px;
            text-align: left;
            transition: border-color 0.3s;
        }
        .light-theme #messages {
            border-color: #333333;
        }
        .message {
            background: rgba(0, 255, 234, 0.2);
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .light-theme .message {
            background: rgba(0, 0, 0, 0.1);
        }
        .message.show {
            opacity: 1;
            transform: translateY(0);
        }
        .user-message {
            background: rgba(0, 255, 234, 0.2);
            color: #00ffea;
        }
        .light-theme .user-message {
            background: rgba(0, 0, 0, 0.1);
            color: #333333;
        }
        .bot-message {
            background: rgba(255, 0, 234, 0.2);
            color: #ff00ea;
        }
        .light-theme .bot-message {
            background: rgba(0, 0, 0, 0.1);
            color: #333333;
        }
        #userInput {
            width: calc(100% - 90px);
            padding: 10px;
            border: 2px solid #00ffea;
            background: black;
            color: #00ffea;
            font-family: 'Press Start 2P', cursive;
            transition: border-color 0.3s, background 0.3s, color 0.3s;
        }
        .light-theme #userInput {
            border-color: #333333;
            background: #ffffff;
            color: #333333;
        }
        button {
            width: 80px;
            padding: 10px;
            background: #00ffea;
            border: none;
            cursor: pointer;
            transition: 0.3s;
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            color: #0a0a0a;
        }
        button:hover {
            background: #ff00ea;
            transform: scale(1.1);
        }
        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(5px); }
            100% { transform: translateY(0px); }
        }
        .floating-text {
            animation: floating 3s infinite ease-in-out;
        }
        #voiceButton, #muteButton, #settingsButton, #helpButton {
            margin-top: 10px;
            padding: 10px;
            cursor: pointer;
            transition: 0.3s;
            font-family: 'Orbitron', sans-serif;
        }
        #voiceButton {
            background: #f33d83;
            color: #ffffff;
        }
        #voiceButton:hover {
            background: #8f1745;
        }
        #muteButton {
            background: #cb0707; 
            color: #ffffff;
        }
        #muteButton:hover {
            background: #7a0b0b;
        }
        #settingsButton {
            background: #00ffea;
            color: #0a0a0a;
        }
        #settingsButton:hover {
            background: #ff00ea;
        }
        #helpButton {
            background: #00ffea;
            color: #0a0a0a;
        }
        #helpButton:hover {
            background: #ff00ea;
        }
        #settingsMenu, #helpMenu {
            display: none;
            margin-top: 10px;
            padding: 10px;
            border: 2px solid #00ffea;
            border-radius: 5px;
            background: rgba(0, 0, 0, 0.8);
            transition: border-color 0.3s, background 0.3s;
        }
        .light-theme #settingsMenu, .light-theme #helpMenu {
            border-color: #333333;
            background: rgba(255, 255, 255, 0.9);
        }
        #settingsMenu label, #helpMenu p {
            display: block;
            margin: 5px 0;
            color: #00ffea;
        }
        .light-theme #settingsMenu label, .light-theme #helpMenu p {
            color: #333333;
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <h2 class="floating-text">ðŸŽ® NieraPX ðŸŽ®</h2>
        <div id="messages"></div>
        <input type="text" id="userInput" placeholder="Type a message..." onkeypress="handleKeyPress(event)">
        <button onclick="sendMessage()">Send</button>
        <button id="voiceButton" onclick="startSpeechRecognition()">Voice</button>
        <button id="muteButton" onclick="toggleMute()">Mute</button>
        <button id="settingsButton" onclick="toggleSettings()">Settings</button>
        <button id="helpButton" onclick="toggleHelp()">Help</button>

        <!-- Settings Menu -->
        <div id="settingsMenu">
            <label>
                Pitch: <input type="range" id="pitchSlider" min="0.5" max="2" step="0.1" value="1.0">
            </label>
            <label>
                Rate: <input type="range" id="rateSlider" min="0.5" max="2" step="0.1" value="1.0">
            </label>
            <label>
                Voice Input Keybind: <input type="text" id="voiceKeybind" value="Shift + F1">
            </label>
            <label>
                Mute Keybind: <input type="text" id="muteKeybind" value="Shift + F2">
            </label>
            <button onclick="testVoice()">Test Voice</button>
            <button onclick="toggleTheme()">Toggle Theme</button>
            <button onclick="resetToDefault()">Reset to Default</button>
        </div>

        <!-- Help Menu -->
        <div id="helpMenu">
            <p><strong>Hotkeys:</strong></p>
            <p>Voice Input: <kbd id="voiceKeybindDisplay">Shift + F1</kbd></p>
            <p>Mute/Unmute: <kbd id="muteKeybindDisplay">Shift + F2</kbd></p>
            <p><strong>Settings:</strong></p>
            <p>Adjust voice pitch and rate, test the voice, and toggle themes.</p>
        </div>
    </div>
    <script>
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.continuous = false;
        recognition.interimResults = false;
        recognition.lang = "en-US";

        const synth = window.speechSynthesis;
        let isMuted = false;
        let selectedVoice = null;
        let pitch = 1.0;
        let rate = 1.0;
        let voiceKeybind = "Shift + F1"; // Updated default keybind
        let muteKeybind = "Shift + F2"; // Updated default keybind
        let currentUtterance = null;

        // Arcade beep sound
        function playArcadeBeep() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.type = "square"; // Retro-style sound
            oscillator.frequency.setValueAtTime(isMuted ? 220 : 440, audioContext.currentTime); // Low pitch for mute, high for unmute
            gainNode.gain.setValueAtTime(1, audioContext.currentTime);

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.1); // Short beep (100ms)
        }

        // Set preferred voice
        function setPreferredVoice() {
            let voices = synth.getVoices();
            if (!voices.length) {
                setTimeout(setPreferredVoice, 100);
                return;
            }
            selectedVoice = voices.find(voice => 
                voice.name.includes("Google UK English Male") || 
                voice.name.includes("Google US English")
            ) || voices[0];
        }

        // Handle key press for input
        function handleKeyPress(event) {
            if (event.key === "Enter") {
                sendMessage();
            }
        }

        // Send message to backend
        function sendMessage() {
            const input = document.getElementById("userInput");
            const message = input.value.trim();
            if (message) {
                addMessage(message, "user-message");

                fetch("/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: message }),
                })
                .then(response => response.json())
                .then(data => {
                    let cleanResponse = data.response.replace(/\*\*/g, ""); // Remove asterisks
                    addMessage(cleanResponse, "bot-message");
                    if (!isMuted) {
                        speakResponse(cleanResponse); // Speak cleaned text
                    }
                });

                input.value = "";
            }
        }

        // Add message to chat
        function addMessage(text, className) {
            const messagesDiv = document.getElementById("messages");
            const messageElement = document.createElement("div");
            messageElement.classList.add("message", className);
            messageElement.innerText = text;
            messagesDiv.appendChild(messageElement);
            setTimeout(() => messageElement.classList.add("show"), 100);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Start speech recognition
        function startSpeechRecognition() {
            recognition.start();
            document.getElementById("voiceButton").textContent = "Listening...";
        }

        // Handle speech recognition results
        recognition.onresult = (event) => {
            document.getElementById("userInput").value = event.results[0][0].transcript;
            sendMessage();
        };

        // Handle speech recognition end
        recognition.onend = () => {
            document.getElementById("voiceButton").textContent = "Voice";
        };

        // Speak response
        function speakResponse(text) {
            if (isMuted) return;
            synth.cancel(); // Cancel any ongoing speech
            if (!selectedVoice) setPreferredVoice();

            const cleanText = text.replace(/\*\*/g, "");
            currentUtterance = new SpeechSynthesisUtterance(cleanText); // Store in a global variable
            currentUtterance.voice = selectedVoice;
            currentUtterance.pitch = pitch;
            currentUtterance.rate = rate;

            // Handle long text by splitting into chunks
            if (cleanText.length > 200) {
                const chunks = splitTextIntoChunks(cleanText, 200);
                speakChunks(chunks);
            } else {
                synth.speak(currentUtterance);
            }
        }

        // Split long text into smaller chunks
        function splitTextIntoChunks(text, chunkSize) {
            const chunks = [];
            for (let i = 0; i < text.length; i += chunkSize) {
                chunks.push(text.slice(i, i + chunkSize));
            }
            return chunks;
        }

        // Speak text chunks sequentially
        function speakChunks(chunks, index = 0) {
            if (index >= chunks.length) return;

            currentUtterance = new SpeechSynthesisUtterance(chunks[index]);
            currentUtterance.voice = selectedVoice;
            currentUtterance.pitch = pitch;
            currentUtterance.rate = rate;

            currentUtterance.onend = () => {
                speakChunks(chunks, index + 1); // Speak the next chunk
            };

            synth.speak(currentUtterance);
        }

        // Toggle mute/unmute
        function toggleMute() {
            isMuted = !isMuted;
            document.getElementById("muteButton").textContent = isMuted ? "Unmute" : "Mute";
            if (isMuted) synth.cancel();
            playArcadeBeep(); // Play arcade beep when toggling mute
        }

        // Toggle settings menu
        function toggleSettings() {
            const settingsMenu = document.getElementById("settingsMenu");
            settingsMenu.style.display = settingsMenu.style.display === "block" ? "none" : "block";
        }

        // Toggle help menu
        function toggleHelp() {
            const helpMenu = document.getElementById("helpMenu");
            helpMenu.style.display = helpMenu.style.display === "block" ? "none" : "block";
        }

        // Test voice
        function testVoice() {
            speakResponse("This is a test of the voice output.");
        }

        // Toggle theme
        function toggleTheme() {
            document.body.classList.toggle("light-theme");
        }

        // Reset to default settings
        function resetToDefault() {
            pitch = 1.0;
            rate = 1.0;
            voiceKeybind = "Shift + F1"; // Reset to new default
            muteKeybind = "Shift + F2"; // Reset to new default
            document.getElementById("pitchSlider").value = pitch;
            document.getElementById("rateSlider").value = rate;
            document.getElementById("voiceKeybind").value = voiceKeybind;
            document.getElementById("muteKeybind").value = muteKeybind;
            document.getElementById("voiceKeybindDisplay").textContent = voiceKeybind;
            document.getElementById("muteKeybindDisplay").textContent = muteKeybind;
        }

        // Update pitch and rate
        document.getElementById("pitchSlider").oninput = (e) => {
            pitch = parseFloat(e.target.value);
        };
        document.getElementById("rateSlider").oninput = (e) => {
            rate = parseFloat(e.target.value);
        };

        // Update keybinds
        document.getElementById("voiceKeybind").oninput = (e) => {
            voiceKeybind = e.target.value;
            document.getElementById("voiceKeybindDisplay").textContent = voiceKeybind;
        };
        document.getElementById("muteKeybind").oninput = (e) => {
            muteKeybind = e.target.value;
            document.getElementById("muteKeybindDisplay").textContent = muteKeybind;
        };

        // Hotkeys
        document.addEventListener("keydown", (e) => {
            if (e.shiftKey && e.key === "F1") { // Shift + F1 for voice input
                startSpeechRecognition();
            }
            if (e.shiftKey && e.key === "F2") { // Shift + F2 for mute/unmute
                toggleMute();
            }
        });

        synth.onvoiceschanged = setPreferredVoice;
    </script>
</body>
</html>